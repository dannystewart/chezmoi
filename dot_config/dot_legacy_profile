#!/bin/bash
# shellcheck disable=SC1091,SC2016

# Basic config setup
PUID=$(id -u) && export PUID
PGID=$(id -g) && export PGID
export TZ="America/New_York"
export HOMEBREW_NO_ENV_HINTS="true"
# export TIME_STYLE="default"
export LSCOLORS="Gxfxcxdxbxegedabagacad"
export LS_COLORS="di=1;36:ln=35:so=32:pi=33:ex=31:bd=34;46:cd=34;43:su=30;41:sg=30;46:tw=30;42:ow=30;43"

# Homebrew local storage space workaround
[[ "$(uname)" == "Linux" ]] && export HOMEBREW_TEMP=/var/tmp

# Reset PATH to system defaults
PATH=$(getconf PATH)

# Paths to add (lower paths come first)
PATH_LIST="
/opt/local/bin
/sbin
/System/Cryptexes/App/usr/bin
/Library/Apple/usr/bin
/usr/libexec
/usr/local/bin
$HOME/.local/bin/node
$HOME/.local/bin
$HOME/.bin
$HOME/bin
$HOME/.pyenv/bin
$HOME/.pyenv/shims
$HOME/.rbenv/bin
$HOME/.cargo/bin
/var/lib/snapd/snap/bin
/usr/local/opt/findutils/libexec/gnubin
/opt/homebrew/opt/findutils/libexec/gnubin
/opt/homebrew/opt/openjdk/bin
"

# Use subshell to set PATH
PATH=$(echo "$PATH_LIST" | while read -r dir; do
    if [ -n "$dir" ] && [ -d "$dir" ]; then
        echo -n "$dir:"
    fi
done)$PATH

# Ensure critical system paths are included
for dir in /usr/local/sbin /usr/local/bin /usr/sbin /usr/bin /sbin /bin; do
    if [[ ":$PATH:" != *":$dir:"* ]]; then
        PATH="$PATH:$dir"
    fi
done

# Add LM Studio to path if installed
[ -d "$HOME/.lmstudio/bin" ] && PATH="$PATH:$HOME/.lmstudio/bin"

# Run path_helper if it exists
[ -f /usr/libexec/path_helper ] && eval "$(/usr/libexec/path_helper -s)"

# Homebrew
if [[ -f /opt/homebrew/bin/brew ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
elif [[ -f /usr/local/bin/brew ]]; then
    eval "$(/usr/local/bin/brew shellenv)"
elif [[ -f /home/linuxbrew/.linuxbrew/bin/brew ]]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi

# Import 1Password if it exists
[ -f "$HOME/.config/op/plugins.sh" ] && source "$HOME/.config/op/plugins.sh"

# Set Visual Studio Code as default editor if installed
command -v code >/dev/null 2>&1 && export EDITOR=code

# Initialize pyenv
if [ "$(command -v pyenv)" ]; then
    eval "$(pyenv init -)"
    export PYENV_PIP_PACKAGES="argparse halo inquirer python-dotenv requests termcolor"
    [ "$(command -v pyenv-virtualenv-init)" ] && eval "$(pyenv virtualenv-init -)"
fi

# Add our Python user bin to PYTHONPATH if it exists
if [ -z "$PYTHONPATH" ]; then
    export PYTHONPATH="$HOME/.local/bin"
else
    export PYTHONPATH="$PYTHONPATH:$HOME/.local/bin"
fi

# Initialize FNM (Fast Node Manager)
if [ "$(command -v fnm)" ]; then eval "$(fnm env --use-on-cd)"; fi

# Lazy loading for rarely used tools
_lazy_load() {
    local tool=$1
    local init_file="$HOME/.${tool}_init"
    if [ ! -f "$init_file" ]; then
        case $tool in
            rbenv)
                echo 'eval "$(rbenv init -)"' > "$init_file"
                ;;
            cargo)
                echo 'source "$HOME/.cargo/env"' > "$init_file"
                ;;
        esac
    fi
    eval "${tool}() { unset -f ${tool}; source ${init_file}; ${tool} \$@; }"
}

# Set up lazy loading for rarely used tools
[ "$(command -v rbenv)" ] && _lazy_load rbenv
[ -d "$HOME/.cargo/env" ] && _lazy_load cargo
[ -d "$HOME/.config/nvm" ] && _lazy_load nvm

# Steam Tinker Launch for Steam Deck
[ -d "/home/deck/stl/prefix" ] && export PATH="$PATH:/home/deck/stl/prefix"

# Export final PATH
export PATH
